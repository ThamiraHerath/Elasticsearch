pr: 114842
summary: "ESQL: Introduce per agg filter"
area: ES|QL
type: feature
issues: []
highlight:
  title: "ESQL: Introduce per agg filter"
  body: "Add support for aggregation scoped filters that work dynamically on the \n\
    data in each group.\n\n| STATS     success = COUNT(*) WHERE 200 <= code AND code\
    \ < 300,   \nredirect = COUNT(*) WHERE 300 <= code AND code < 400,  client_err\
    \ =\nCOUNT(*) WHERE 400 <= code AND code < 500,  server_err = COUNT(*) WHERE\n\
    500 <= code AND code < 600,  total_count = COUNT(*)\n\nImplementation wise, the\
    \ base AggregateFunction has been extended to \nallow a filter to be passed on.\
    \ This is required to incorporate the \nfilter as part of the aggregate equality/identify\
    \ which would fail with \nthe filter as an external component.\n\nAs part of the\
    \ process, the serialization for the existing aggregations \nhad to be fixed so\
    \ AggregateFunction implementations so that it \ndelegates to their parent first.\n\
    \n(cherry picked from commit d102659dce45a56020423f2802478ebd0c3ef341)\n\n<!--\
    \ Thank you for your interest in and contributing to Elasticsearch!\nThere are\
    \ a few simple things to check before submitting your pull\nrequest that can help\
    \ with the review process. You should delete these\nitems from your submission,\
    \ but they are here to help bring them to your\nattention. -->\n\n- Have you signed\
    \ the [contributor license agreement](https://www.elastic.co/contributor-agreement)?\n\
    - Have you followed the [contributor guidelines](https://github.com/elastic/elasticsearch/blob/main/CONTRIBUTING.md)?\n\
    - If submitting code, have you built your formula locally prior to submission\
    \ with `gradle check`?\n- If submitting code, is your pull request against main?\
    \ Unless there is a good reason otherwise, we prefer pull requests against main\
    \ and will backport as needed.\n- If submitting code, have you checked that your\
    \ submission is for an [OS and architecture that we support](https://www.elastic.co/support/matrix#show_os)?\n\
    - If you are submitting this code for a class then read our [policy](https://github.com/elastic/elasticsearch/blob/main/CONTRIBUTING.md#contributing-as-part-of-a-class)\
    \ for that."
  notable: true
